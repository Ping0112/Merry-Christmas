<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Magic Christmas Memory</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* Video Camera n·ªÅn */
        #input-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0;
        }
        
        /* L·ªõp 3D */
        #canvas-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1; touch-action: none; 
        }

        /* M√†n h√¨nh ch√†o */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center; padding: 20px; box-sizing: border-box;
        }
        #start-btn {
            padding: 15px 50px; font-size: 18px; background: #d40000; color: white;
            border: 2px solid #ffd700; border-radius: 50px; cursor: pointer;
            margin-top: 25px; font-weight: bold; box-shadow: 0 0 20px rgba(212, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* H∆∞·ªõng d·∫´n */
        #hint {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #ffd700; font-size: 14px; z-index: 10; font-weight: bold;
            text-shadow: 0 2px 4px black; pointer-events: none;
            opacity: 0; transition: opacity 1s;
        }

        /* N√∫t B·∫≠t/T·∫Øt Nh·∫°c */
        #music-toggle {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.5); color: white; border: 1px solid white;
            width: 40px; height: 40px; border-radius: 50%;
            display: none; /* ·∫®n l√∫c ƒë·∫ßu */
            align-items: center; justify-content: center; font-size: 20px; cursor: pointer;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <audio id="bg-music" loop>
        <source src="media/music.mp3" type="audio/mp3">
    </audio>

    <video id="input-video" playsinline muted autoplay></video>
    
    <div id="start-overlay">
        <h1 style="color: #ffd700; text-shadow: 0 0 10px orange; margin: 0;">üéÑ H·ªòP QU√Ä K√ù ·ª®C üéÑ</h1>
        <p style="color: #ddd; margin-top: 15px; line-height: 1.6;">
            Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√¥ng gian Gi√°ng sinh.<br>
            <span style="color: #ffd700; font-weight: bold;">Ch·∫°m & Gi·ªØ tay tr√™n m√†n h√¨nh</span><br>
            ƒë·ªÉ m·ªü h·ªôp qu√† b√≠ m·∫≠t nh√©!
        </p>
        <button id="start-btn">M·ªû QU√Ä & B·∫¨T NH·∫†C üé∂</button>
        <p style="font-size: 11px; color: #777; margin-top: 20px;">*Y√™u c·∫ßu quy·ªÅn Camera</p>
    </div>

    <div id="hint">üëÜ Gi·ªØ tay ƒë·ªÉ xem ·∫£nh k·ª∑ ni·ªám</div>
    <div id="music-toggle">üîä</div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';

        // --- C·∫§U H√åNH ---
        const CONFIG = {
            particleCount: 1800, treeHeight: 25, treeRadius: 10, ringRadius: 18, 
            colors: [0xff0000, 0x00ff00, 0xffd700, 0xffffff] 
        };

        let scene, camera, renderer, particles, photoGroup, photoMesh;
        let treePositions = [], ringPositions = [];
        let isTouching = false;
        let imageList = [];
        let loadedTextures = {};

        // --- 1. SETUP ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('hint').style.opacity = 1;
            
            // X·ª≠ l√Ω Nh·∫°c
            const music = document.getElementById('bg-music');
            const musicBtn = document.getElementById('music-toggle');
            music.volume = 0.5;
            music.play().then(() => {
                musicBtn.style.display = 'flex';
            }).catch(e => console.log("Kh√¥ng th·ªÉ t·ª± ph√°t nh·∫°c:", e));

            setupCamera();
            init3D();
            loadMediaManifest();
        });

        // X·ª≠ l√Ω n√∫t t·∫Øt/b·∫≠t nh·∫°c
        document.getElementById('music-toggle').addEventListener('click', function() {
            const music = document.getElementById('bg-music');
            if (music.paused) {
                music.play();
                this.innerText = 'üîä';
            } else {
                music.pause();
                this.innerText = 'üîá';
            }
        });

        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                video.play();
            } catch (err) { console.log("Camera denied:", err); }
        }

        async function loadMediaManifest() {
            try {
                const res = await fetch('media/manifest.json');
                const data = await res.json();
                imageList = data.images || [];
            } catch (e) { console.warn('Manifest loading failed'); }
        }

        // --- 2. 3D SCENE ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 50);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio > 2 ? 2 : window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            createParticles();
            createPhotoFrame(); // ƒê√£ s·ª≠a m√†u tr·∫Øng trong h√†m n√†y
            setupInteraction();
            animate();
        }

        function createParticles() {
            const posArray = [], colArray = [], sizeArray = [];
            const colorHelper = new THREE.Color();
            for (let i = 0; i < CONFIG.particleCount; i++) {
                const h = i / CONFIG.particleCount; 
                const angle = i * 0.15;
                const r = (1 - h) * CONFIG.treeRadius + h * 2; 
                const x = r * Math.cos(angle * 5 + i);
                const y = (0.5 - h) * CONFIG.treeHeight;
                const z = r * Math.sin(angle * 5 + i);
                treePositions.push(x, y, z);
                
                const ringAngle = Math.random() * Math.PI * 2;
                const ringR = CONFIG.ringRadius + Math.random() * 5;
                ringPositions.push(ringR * Math.cos(ringAngle), (Math.random()-0.5)*30, ringR * Math.sin(ringAngle));
                
                posArray.push(x, y, z);
                colorHelper.setHex(CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]);
                colArray.push(colorHelper.r, colorHelper.g, colorHelper.b);
                sizeArray.push(Math.random());
            }
            const pGeo = new THREE.BufferGeometry();
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(posArray, 3));
            pGeo.setAttribute('color', new THREE.Float32BufferAttribute(colArray, 3));
            pGeo.setAttribute('size', new THREE.Float32BufferAttribute(sizeArray, 1));
            particles = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.8, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.9 }));
            scene.add(particles);
        }

        function createPhotoFrame() {
            photoGroup = new THREE.Group();
            
            // Khung vi·ªÅn v√†ng
            const frameMesh = new THREE.Mesh(new THREE.PlaneGeometry(16.5, 12.5), new THREE.MeshBasicMaterial({ color: 0xffd700 }));
            frameMesh.position.z = -0.1;
            photoGroup.add(frameMesh);
            
            // === ƒê√É S·ª¨A: ƒê·ªïi m√†u ƒëen (0x000000) th√†nh m√†u tr·∫Øng (0xffffff) ===
            photoMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(16, 12), 
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0 })
            );
            photoGroup.add(photoMesh);
            
            photoGroup.visible = false;
            scene.add(photoGroup);
        }

        function showRandomPhoto() {
            if (imageList.length === 0) return;
            const imgPath = `media/${imageList[Math.floor(Math.random() * imageList.length)]}`;
            const updateTex = (tex) => {
                photoMesh.material.map = tex;
                const aspect = tex.image.width / tex.image.height;
                photoMesh.scale.set(aspect, 1, 1); 
                photoGroup.children[0].scale.set(aspect * 1.05, 1.05, 1);
                photoMesh.material.needsUpdate = true;
            };
            if (loadedTextures[imgPath]) updateTex(loadedTextures[imgPath]);
            else new THREE.TextureLoader().load(imgPath, (tex) => { loadedTextures[imgPath] = tex; updateTex(tex); });
            photoGroup.visible = true;
        }

        function setupInteraction() {
            const onDown = () => { if(!isTouching) { isTouching = true; showRandomPhoto(); document.getElementById('hint').style.opacity = 0; }};
            const onUp = () => { isTouching = false; };
            window.addEventListener('pointerdown', onDown); window.addEventListener('pointerup', onUp);
            window.addEventListener('touchstart', onDown); window.addEventListener('touchend', onUp);
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }

        function animate() {
            requestAnimationFrame(animate);
            const pos = particles.geometry.attributes.position.array;
            const target = isTouching ? ringPositions : treePositions;
            const lerpSpeed = isTouching ? 0.05 : 0.08;
            for (let i = 0; i < CONFIG.particleCount * 3; i++) pos[i] += (target[i] - pos[i]) * lerpSpeed;
            particles.geometry.attributes.position.needsUpdate = true;

            if (isTouching) {
                if (photoMesh.material.opacity < 1) photoMesh.material.opacity += 0.05;
                photoGroup.scale.setScalar(THREE.MathUtils.lerp(photoGroup.scale.x, 1, 0.1));
                particles.rotation.y += 0.002;
            } else {
                if (photoMesh.material.opacity > 0) photoMesh.material.opacity -= 0.1;
                else photoGroup.visible = false;
                photoGroup.scale.setScalar(0.8);
                particles.rotation.y += 0.01;
            }
            const sizes = particles.geometry.attributes.size.array;
            for(let i=0; i < CONFIG.particleCount; i++) sizes[i] = 0.5 + 0.5 * Math.sin(Date.now() * 0.005 + i);
            particles.geometry.attributes.size.needsUpdate = true;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
